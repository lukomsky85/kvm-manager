Вот полное описание KVM-менеджера с исправлениями для корректной работы на CentOS/RHEL:

---

### **KVM Manager v1.5.2**
Полнофункциональный скрипт для управления виртуальными машинами KVM с поддержкой:
- Управления ВМ через CLI
- Кластерных конфигураций
- Различных типов хранилищ (LVM, ZFS, Ceph, NFS)
- Мониторинга и API
- Установки Proxmox VE и oVirt Engine

---

### **Основные функции**

1. **Управление виртуальными машинами**:
   - Создание/удаление ВМ
   - Бекап и восстановление
   - Live-миграция между хостами

2. **Поддержка хранилищ**:
   ```bash
   NFS   - Сетевые файловые системы
   LVM   - Логические тома
   ZFS   - Продвинутое файловое хранилище
   Ceph  - Распределенное хранилище
   ```

3. **Мониторинг**:
   - Встроенный node_exporter
   - Сбор метрик CPU/RAM ВМ
   - Systemd-сервис для автоматического запуска

4. **API интерфейс**:
   ```bash
   REST API на Flask (порт 8080)
   Эндпоинты:
   - /api/vms       - Список всех ВМ
   - /api/vms/<name> - Инфо о конкретной ВМ
   ```

---

### **Исправленные проблемы**

1. **Установка node_exporter**:
   - Автоматическое создание пользователя
   - Проверка существующих инсталляций
   - Корректная обработка путей при распаковке

2. **ZFS на CentOS/RHEL**:
   ```bash
   # Старый вариант (с ошибкой)
   rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-zfsonlinux
   
   # Новый исправленный вариант
   rpm --import https://zfsonlinux.org/gpg.key
   ```

3. **Системные зависимости**:
   - Автоматическая установка EPEL-репозитория
   - Проверка доступности пакетов
   - Гибкая настройка через переменные

---

### **Примеры использования**

1. **Создание ВМ**:
   ```bash
   ./kvm-manager.sh
   > Выберите опцию: 1
   > Введите имя ВМ: my-vm
   > Укажите параметры...
   ```

2. **Настройка хранилища**:
   ```bash
   ./kvm-manager.sh
   > Выберите опцию: 6
   > Выберите тип хранилища: 5 (LVM)
   ```

3. **Запуск API**:
   ```bash
   ./kvm-manager.sh
   > Выберите опцию: 8
   # Проверить:
   curl http://localhost:8080/api/vms
   ```

---

### **Требования**

| ОС           | Поддержка       |
|--------------|----------------|
| CentOS 7+    | ✅ Полная       |
| RHEL 8+      | ✅ Полная       |
| Ubuntu 20.04+| ✅ Полная       |
| Debian 11+   | ✅ Полная       |

---

### **Логирование**
Все действия записываются в:
```bash
/var/log/kvm_manager.log
```

Формат логов:
```log
2025-04-14 10:00:00 - [STATUS] Сообщение
```

---

### **Безопасность**
1. Автоматическая генерация паролей для:
   - oVirt Engine
   - Proxmox VE
2. Сохранение учетных данных в:
   ```bash
   /etc/ovirt-engine/credentials.txt
   /root/proxmox_credentials.txt
   ```
3. Права доступа 600 для всех конфиденциальных файлов

---

### **Рекомендации по устранению проблем**

1. **Ошибка ZFS**:
   ```bash
   # Переустановка модуля
   dnf reinstall zfs
   # Проверка модуля
   lsmod | grep zfs
   ```

2. **Проблемы с node_exporter**:
   ```bash
   # Принудительный рестарт
   systemctl restart node_exporter
   # Проверка логов
   journalctl -u node_exporter -f
   ```

3. **Очистка перед переустановкой**:
   ```bash
   # Для node_exporter
   userdel node_exporter
   rm -f /usr/local/bin/node_exporter
   ```

---

### **Дополнительные возможности**
- Поддержка cloud-init
- Автоматическая загрузка ISO образов
- Интеграция с Ceph RBD
- Настройка сетевых мостов

Скрипт продолжает развиваться - новые функции добавляются регулярно! Для обновления используйте:
```bash
curl -s https://raw.githubusercontent.com/lukomsky85/kvm-manager/main/kvm-manager.sh > kvm-manager.sh
```
